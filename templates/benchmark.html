{% extends "base.html" %}

{% block title %}{{name}}{% endblock %}

{% block head %}
<style>
</style>
{% endblock %}

{% block content %}
<h1><a href="../index.html">lolbench</a></h1>
<h2>benchmark name: {{name}}</h2>

{% for metric in self.metrics_with_anomaly_indices() %}
<a id="{{ metric }}"></a>
<h3><a href="#{{ metric }}">*</a> {{ metric }} / iteration</h3>

<div id="{{ metric }}-chart" style="width: 100%; height: 600px"></div>

<h4>potential anomalies</h4>
<table border="1">
    <thead>
        <tr>
            <th>toolchain</th>
            <th>delta</th>
        </tr>
    </thead>
    <tbody>
        {% for timing in anomalous_timings %}
        <tr>
            <td>{{ timing.0 }}</td>
            <td>{{ timing.1.index[metric] }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endfor %}

<a id="branch-predict-ratio"></a>
<h3><a href="#branch-predict-ratio">*</a> overall branch predict ratio</h3>
<div id="branch-predict-ratio-chart" style="width: 100%; height: 600px"></div>

<a id="cache-ratio"></a>
<h3><a href="#cache-ratio">*</a> overall cache hit ratio</h3>
<div id="cache-ratio-chart" style="width: 100%; height: 600px"></div>

<script src="https://cdn.jsdelivr.net/npm/highcharts@6/highcharts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highcharts@6/highcharts-more.min.js"></script>

<script>
    const means = JSON.parse(`{{means|json}}`);
    const stdDevs = JSON.parse(`{{std_devs|json}}`);
    const anomalyData = JSON.parse(`{{anomalous_timings|json}}`);
    const chartData = JSON.parse(`{{timings|json}}`);
    chartData.reverse();

    const labels = chartData.map(t => new Date(t.toolchains[0].spec.replace('nightly-', '')).valueOf());

    const colors = {
        'nanoseconds': '#E43717',
        'instructions': 'green',
        'cpu_cycles': 'blue',
        'branch_instructions': 'red',
        'branch_misses': 'purple',
        'cache_references': '#16a085',
        'cache_misses': 'black',
        'confidence': '#9bffb1'
    };

    const makeChart = (elemId, title, field, data) => {
        const mean = means[field] ? means[field].median : null;
        const stdDev = stdDevs[field] ? stdDevs[field].median : null;
        const confidenceLow = mean - (stdDev * 2);
        const confidenceHigh = mean + (stdDev * 2);

        Highcharts.chart(elemId, {
            title: false,
            xAxis: {
                type: 'datetime',
                title: {
                    text: 'Nightly Build'
                }
            },
            yAxis: {
                title: {
                    text: field
                },
                plotBands: [{
                    from: confidenceLow < 0 ? 0 : confidenceLow,
                    to: confidenceHigh,
                    color: colors['confidence']
                }],
                plotLines: [{
                    value: mean,
                    color: 'black',
                    dashStyle: 'Dash',
                    label: {
                        text: 'Mean'
                    },
                    width: 2,
                    zIndex: 1
                }]
            },
            series: [{
                data: data.map((metric, i) => ([labels[i], metric.median])),
                type: 'spline',
                lineWidth: 4,
                marker: {
                    radius: 4
                },
                color: colors[field],
                name: field
            }, {
                name: 'margin of error',
                type: 'errorbar',
                data: data.map((metric, i) => ([labels[i], metric.lower_bound, metric.upper_bound])),
                color: 'black',
                tooltip: {
                    pointFormat: `(error range: {point.low}-{point.high} ${field})<br/>`
                }
            }],
            tooltip: {
                dateTimeLabelFormats: {
                    day: 'nightly-%Y-%m-%d'
                }
            },
            plotOptions: {
                spline: {
                    animation: false,
                    marker: {
                        enabled: true
                    }
                },
                errorbar: {
                    animation: false,
                }
            },
            credits: false
        });
    };

    const hitRatio = (accessField, missField) => {
        return chartData.map(t => {
            const access = t.metrics[accessField].median;
            const miss = t.metrics[missField].median;
            return (access - miss) / access;
        });
    };

    makeChart("nanoseconds-chart", "Nanoseconds/Iteration", "nanoseconds", chartData.map(t => t.metrics.nanoseconds));
    makeChart("instructions-chart", "Instructions/Iteration", "instructions", chartData.map(t => t.metrics.instructions));
    makeChart("cpu_cycles-chart", "CPU Cycles/Iteration", "cpu_cycles", chartData.map(t => t.metrics.cpu_cycles));
    makeChart("branch_instructions-chart", "Branch Instructions/Iteration", "branch_instructions", chartData.map(t => t.metrics.branch_instructions));
    makeChart("branch_misses-chart", "Branch Misses/Iteration", "branch_misses", chartData.map(t => t.metrics.branch_misses));
    makeChart("cache_references-chart", "Cache References/Iteration", "cache_references", chartData.map(t => t.metrics.cache_references));
    makeChart("cache_misses-chart", "Cache Misses/Iteration", "cache_misses", chartData.map(t => t.metrics.cache_misses));

    makeChart("branch-predict-ratio-chart", "Overall Branch Predict Ratio", "branch_predict_ratio",
        hitRatio("branch_instructions", "branch_misses"));

    makeChart("cache-ratio-chart", "Overall Cache Hit Ratio", "cache_hit_ratio",
        hitRatio("cache_references", "cache_misses"));


</script>
{% endblock %}
