on: [push, pull_request]
env:
  LOLBENCH_DATA_DIR: /tmp/lolbench
jobs:
  core:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - run: .github/workflows/git-commit-config.sh 
    - uses: actions-rs/cargo@v1
      with:
        command: test-core

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: actions-rs/toolchain@v1
      with:
        components: clippy, rustfmt
    - uses: actions-rs/clippy-check@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        args: --all-features
    - run: cargo fmt-core -- --check

  brotli_1_1_3:
    env:
      LOLBENCH_CRATE: brotli_1_1_3
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - run: .github/workflows/git-commit-config.sh 
    - uses: actions-rs/cargo@v1
      with:
        command: test
        args: --release --package ${{ env.LOLBENCH_CRATE }}
    - uses: actions/upload-artifact@v1
      with:
        name: ${{ env.LOLBENCH_CRATE }}
        path: ${{ env.LOLBENCH_DATA_DIR }}

  # byteorder_1_2_6:
  # clap_2_31_2:
  # crossbeam_epoch_0_4_0:
  # csv_1_0_2:
  # diesel_1_1_1:
  # doom_9e197d7:
  # inflate_0_3_4:
  # json_benchmark_c7d3d9b:
  # nom_4_0_0:
  # quickcheck_0_6_1:
  # rayon_1_0_0:
  # raytrace_8de9020:
  # regex_0_2_6:
  # sha2_0_8_0:
  # sha3_0_8_0:
  # snap_0_2_4:
  rebalance:
    needs: [brotli_1_1_3]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: actions/download-artifact@v1
      with:
        name: brotli_1_1_3
        path: ${{ env.LOLBENCH_DATA_DIR }}

    - uses: actions-rs/cargo@v1
      with:
        command: rebalance-benchmarks
        args: --sample-dir ${{ env.LOLBENCH_DATA_DIR }}

    - uses: actions/upload-artifact@v1
      with:
        name: final_data_dir
        path: ${{ env.LOLBENCH_DATA_DIR }}
    
    - uses: actions/upload-artifact@v1
      with:
        name: registry.toml.balanced
        path: registry.toml
  
  #     - run:
  #         name: build website
  #         command: |
  #           pushd ..
  #           mkdir lolbench-site
  #           git clone https://github.com/anp/lolbench-data.git
  #           popd

  #           cargo build-website --data-dir ../lolbench-data --output-dir ~/lolbench-site
  #     - store_artifacts:
  #         path: ~/lolbench-site

  # screenshots:
  #   docker:
  #     - image: circleci/node:10
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #         at: ~/lolbench-site
  #     - run:
  #         name: install chromium
  #         command: |
  #           sudo apt-get update
  #           # https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md
  #           sudo apt-get install \
  #             gconf-service libasound2 libatk1.0-0 libatk-bridge2.0-0 libc6 libcairo2 libcups2 \
  #             libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 \
  #             libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 \
  #             libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 \
  #             libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates \
  #             fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
  #     - run:
  #         name: install script deps
  #         working_directory: tools
  #         command: npm ci
  #     - run:
  #         name: take screenshots
  #         working_directory: tools
  #         command: npm run screenshots -- --siteDir ~/lolbench-site --outputDir ~/screenshots
  #     - store_artifacts:
  #         path: ~/screenshots

  # deploy:
  #     - run: sudo apt-get install ansible
  #     - run: ./deploy.sh $CIRCLE_SHA1

      # - deploy:
      #     filters:
      #       branches:
      #         only:
      #           - master
      #     requires:
      #       - fmt
      #       - core
      #       - rebalance
      #       - screenshots